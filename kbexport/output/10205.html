<h1>SQL query to inactivate patients based on age and last encounter criteria</h1><h2>10205</h2><h3>Introduction</h3><p>Frequently Peds clinics want to inactivate patients that site has not seen with one or 2 years based on age.</p><h3>Symptom</h3><p></p><h3>Cause</h3><p></p><h3>Workaround</h3><p></p><h3>Resolution</h3><p><P><U><FONT face=Georgia><STRONG>This query will inactivate patients&nbsp; <FONT size=2>&nbsp;&lt;= 3 yrs of age who have not been seen for 1 year.</FONT></STRONG></FONT></U></P><P>Declare @count_this1 TABLE (cpr_id varchar(12), encounter_date datetime)<BR>insert into @count_this1 <BR>SELECT&nbsp;p.cpr_id<BR>&nbsp;,Max(pe.encounter_date)<BR>FROM&nbsp; p_Patient p WITH (NOLOCK),p_patient_encounter pe WITH (NOLOCK)<BR>WHERE p.patient_status = 'ACTIVE'<BR>and datediff(yyyy,p.date_of_birth,getdate()) &lt;= 3<BR>and pe.indirect_flag = 'D'<BR>and pe.cpr_id = p.cpr_id<BR>group by p.cpr_id,p.date_of_birth</P><P>Declare @count_this2 TABLE (cpr_id varchar(12))<BR>insert into @count_this2<BR>SELECT cpr_id<BR>FROM @count_this1<BR>where datediff(YYYY,encounter_date,getdate()) &gt; 1</P><P>select p.billing_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;,p.last_name + ', ' + p.first_name As Patient<BR>&nbsp;,convert(varchar(10),p.date_of_birth,(101)) AS BirthDate<BR>&nbsp;,convert(varchar(10),ct1.encounter_date,(101)) As LastEncounter<BR>from p_patient p,@count_this1 ct1,@count_this2 ct2 <BR>where p.cpr_id = ct1.cpr_id<BR>and ct2.cpr_id = ct1.cpr_id&nbsp;</P><P>/* if you uncomment this below query by removing the "//" below and run this once again then it will show you the list of records going to be inactivated and then inactivate them immediatly */<BR>// update p_patient<BR>// set patient_status = 'Inactive'<BR>// where cpr_id in (select cpr_id from @count_this2)<BR></P><P>&nbsp;</P><P>------------</P><P><STRONG><U><FONT face=Georgia>This query will inactivate patients&nbsp;<FONT size=2> &gt; 3 years and &lt;= 18 years of age who have not been seen for two years.</FONT></FONT></U></STRONG></P><P>Declare @count_this1 TABLE (cpr_id varchar(12), encounter_date datetime,date_of_birth datetime)<BR>insert into @count_this1 <BR>SELECT&nbsp;p.cpr_id<BR>&nbsp;,Max(pe.encounter_date)<BR>&nbsp;,p.date_of_birth<BR>FROM&nbsp; p_Patient p WITH (NOLOCK),p_patient_encounter pe WITH (NOLOCK)<BR>WHERE p.patient_status = 'ACTIVE'<BR>and datediff(YYYY,p.date_of_birth,getdate()) &gt; 3<BR>and datediff(yyyy,p.date_of_birth,getdate()) &lt;= 18<BR>and pe.indirect_flag = 'D'<BR>and pe.cpr_id = p.cpr_id<BR>group by p.cpr_id,p.date_of_birth<BR></P><P>Declare @count_this2 TABLE (cpr_id varchar(12))<BR>insert into @count_this2<BR>SELECT cpr_id<BR>FROM @count_this1<BR>where datediff(YYYY,encounter_date,getdate()) &gt; 2</P><P>select p.billing_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;,p.last_name + ', ' + p.first_name As Patient<BR>&nbsp;,convert(varchar(10),p.date_of_birth,(101)) AS BirthDate<BR>&nbsp;,convert(varchar(10),ct1.encounter_date,(101)) As LastEncounter<BR>from p_patient p,@count_this1 ct1,@count_this2 ct2 <BR>where p.cpr_id = ct1.cpr_id<BR>and ct2.cpr_id = ct1.cpr_id&nbsp;</P><P>/* if you uncomment this below query by removing the "//" below and run this once again then it will show you the list of records going to be inactivated and then inactivate them immediatly */<BR>// update p_patient<BR>// set patient_status = 'Inactive'<BR>// where cpr_id in (select cpr_id from @count_this2)<BR></P><P>----------------------------</P><P>&nbsp;</P><P><STRONG><U><FONT face=Georgia>This query will inactivate patients&nbsp;<FONT size=2> who have not been seen for&nbsp;for any type of visit (Direct/ Indirect) for a given number of &nbsp;years.</FONT></FONT></U></STRONG></P><P><FONT face=Georgia size=2>Declare @count_this1 TABLE (cpr_id varchar(12), encounter_date datetime)<BR>insert into @count_this1 <BR>SELECT p.cpr_id<BR>&nbsp;,Max(pe.encounter_date)<BR>FROM&nbsp; p_Patient p WITH (NOLOCK),p_patient_encounter pe WITH (NOLOCK)<BR>WHERE p.patient_status = 'ACTIVE'<BR>and pe.cpr_id = p.cpr_id<BR>group by p.cpr_id</FONT></P><FONT face=Georgia size=2><P><BR>Declare @count_this2 TABLE (cpr_id varchar(12))<BR>insert into @count_this2<BR>SELECT cpr_id<BR>FROM @count_this1<BR>where datediff(YYYY,encounter_date,getdate()) &gt; 1 -- change this number to your preferred number of years <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --to account for inactivation. this query is restricting to 3 years</P><P><BR>select p.billing_id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,p.last_name + ', ' + p.first_name As Patient<BR>&nbsp;,convert(varchar(10),p.date_of_birth,(101)) AS BirthDate<BR>&nbsp;,convert(varchar(10),ct1.encounter_date,(101)) As LastEncounter<BR>from p_patient p,@count_this1 ct1,@count_this2 ct2 <BR>where p.cpr_id = ct1.cpr_id<BR>and ct2.cpr_id = ct1.cpr_id <BR></P><P>/* if you uncomment this below query by removing the "//" below and run this once again then it will show you the list of records going to be inactivated and then inactivate them immediatly */<BR>// update p_patient<BR>// set patient_status = 'Inactive'<BR>// where cpr_id in (select cpr_id from @count_this2)<BR></P><P>&nbsp;</P><P>----------------------------</FONT></P></p><h3>Notes</h3><p></p>