<h1>Attachments don't appear after migration</h1><h2>10297</h2><h3>Introduction</h3><p>After a version 2 to version 4 migration, sometimes there are attachments which do not appear on the Scan tab in the chart.</p><h3>Symptom</h3><p>On the Scan tab in the chart, there are folders on the left side withnumbers indicating the number of attachments in the folder.&nbsp;However, when the user clicks on the folder to display the attachmentson the right, not all of the attachments are displayed.</p><h3>Cause</h3><p>When the Migration Prep is performed, all of the users are migratedfrom version 2 to version 4.&nbsp; If a user is subsequently added tothe version 2 database prior to the patient data migration, the newuser does not get migrated but all of the patient data entered by thatuser is migrated.&nbsp; This results in some data in the version 4database referencing a non-existent user and causes a number of queriesin the version 4 database to return incomplete information.</p><h3>Workaround</h3><p><p>To copy the missing users from the version 2 database into the version 4 database run the following repair script:</p><p>INSTRUCTIONS:</p><p>1) Substitute the actual version 2 database name for the string %version2db% in this script.<br>&nbsp;&nbsp; Make sure all instances of the string are substituted.<br>2) Execute this script in the version 4 database.&nbsp; Make sure the script completes without errors.</p><p><br>-------------------------------------------------------------</p><p>DECLARE @newusers TABLE (<br>&nbsp;user_id varchar(24) NOT NULL)</p><p><br>INSERT INTO @newusers (<br>&nbsp;user_id <br>&nbsp; )<br>SELECT u.[user_id]<br>FROM %version2db%..c_User u<br>WHERE u.user_id not in (<br>&nbsp;SELECT user_id<br>&nbsp;FROM c_User)<br>AND user_id NOT LIKE '#%'</p><p>INSERT INTO c_User (<br>&nbsp;user_id ,<br>&nbsp;specialty_id ,<br>&nbsp;user_status,<br>&nbsp;user_full_name ,<br>&nbsp;user_short_name ,<br>&nbsp;color,<br>&nbsp;office_id ,<br>&nbsp;access_id,<br>&nbsp;user_initial ,<br>&nbsp;first_name,<br>&nbsp;middle_name ,<br>&nbsp;last_name,<br>&nbsp;degree ,<br>&nbsp;name_prefix ,<br>&nbsp;name_suffix,<br>&nbsp;dea_number,<br>&nbsp;license_number,<br>&nbsp;signature_stamp,<br>&nbsp;supervisor_user_id,<br>&nbsp;certified,<br>&nbsp;billing_id,<br>&nbsp;billing_code ,<br>--&nbsp;license_flag ,<br>&nbsp;activate_date,<br>&nbsp;modified,<br>&nbsp;modified_by,<br>&nbsp;created,<br>&nbsp;created_by<br>&nbsp; )<br>SELECT u.[user_id] ,<br>&nbsp;specialty = CASE p.[specialty_id]<br>&nbsp;&nbsp;&nbsp;WHEN 'PEDS' THEN '$PEDS'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN 'FP' THEN '$FP'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 'OBGYN' THEN '$OBGYN'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 'ALLERGY' THEN '$ALLERGY'<br>&nbsp;&nbsp;&nbsp;WHEN 'IM' THEN '$IM'<br>&nbsp;&nbsp;&nbsp;ELSE '%default_specialty%'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END,<br>&nbsp;u.[user_status],<br>&nbsp;u.[user_full_name] ,<br>&nbsp;u.[user_short_name] ,<br>&nbsp;u.[color],<br>&nbsp;u.[office_id] ,<br>&nbsp;u.[access_id],<br>&nbsp;u.[user_initial] ,<br>&nbsp;p.[first_name],<br>&nbsp;p.[middle_name] ,<br>&nbsp;p.[last_name],<br>&nbsp;p.[degree] ,<br>&nbsp;p.[name_prefix] ,<br>&nbsp;p.[name_suffix],<br>&nbsp;p.[dea_number],<br>&nbsp;p.[license_number],<br>&nbsp;p.[signature_file],<br>&nbsp;p.[supervisor_provider_id],<br>&nbsp;p.[certified],<br>&nbsp;p.[billing_id],<br>&nbsp;p.[billing_code] ,<br>--&nbsp;p.[license_flag] ,<br>&nbsp;CASE user_status WHEN 'NA' THEN '1/1/1990' ELSE getdate() END ,<br>&nbsp;getdate() ,<br>&nbsp;'!SYSTEM' ,<br>&nbsp;getdate() ,<br>&nbsp;'!SYSTEM'<br>FROM %version2db%..c_User u<br>&nbsp;LEFT OUTER JOIN %version2db%..c_Provider p<br>&nbsp;ON u.user_id = p.provider_id<br>&nbsp;INNER JOIN @newusers x<br>&nbsp;ON u.user_id = x.user_id</p><p><br>/*******************<br>&nbsp;Build c_User_Role<br>*******************/ </p><p>INSERT INTO c_User_Role( <br>&nbsp;user_id,<br>&nbsp;role_id,<br>&nbsp;role_order<br>&nbsp;)<br>SELECT a.user_id,<br>&nbsp;role_id = CASE b.user_class<br>&nbsp;&nbsp;&nbsp;WHEN 'ADMIN' THEN '!ADMIN'<br>&nbsp;&nbsp;&nbsp;WHEN 'NP' THEN '!NP'<br>&nbsp;&nbsp;&nbsp;WHEN 'NURSE' THEN '!NURSE'<br>&nbsp;&nbsp;&nbsp;WHEN 'TECHNICIAN' THEN '!TECHNICIAN'<br>&nbsp;&nbsp; &nbsp;&nbsp;WHEN 'PHYSICIAN' THEN '!PHYSICIAN'<br>&nbsp;&nbsp; &nbsp;&nbsp;WHEN 'PA' THEN '!PA'<br>&nbsp;&nbsp; &nbsp;&nbsp;WHEN 'PHONE' THEN '!PHONE'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;WHEN 'PHARMACIST' THEN '!PHARMACIST'<br>&nbsp;&nbsp; &nbsp;&nbsp;WHEN 'FRONTDESK' THEN '!FRONTDESK'<br>&nbsp;&nbsp;&nbsp;WHEN '!SYSTEM' THEN '!SYSTEM'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;ELSE '!CliniSupp'<br>&nbsp;&nbsp; &nbsp;&nbsp;END,<br>&nbsp;1<br>FROM %version2db%..c_user b<br>&nbsp;INNER JOIN c_user a<br>&nbsp;ON a.user_id = b.user_id<br>&nbsp;INNER JOIN @newusers x<br>&nbsp;ON a.user_id = x.user_id</p><p>-- Add every user in 'clinical staff role<br>INSERT INTO c_User_Role (<br>&nbsp;user_id,<br>&nbsp;role_id,<br>&nbsp;role_order<br>&nbsp;)<br>SELECT a.user_id,<br>&nbsp;'!CliniSupp',<br>&nbsp;1<br>FROM c_user a<br>&nbsp;INNER JOIN @newusers x<br>&nbsp;ON a.user_id = x.user_id<br>WHERE a.user_status not in ('SYSTEM','SPECIAL','ROLE')<br>AND NOT EXISTS (<br>&nbsp;SELECT user_id<br>&nbsp;FROM c_user_role b<br>&nbsp;WHERE a.user_id = b.user_id<br>&nbsp;AND b.role_id = '!CliniSupp'<br>&nbsp;)<br>GO<br></p><p>DECLARE @ldt_patients_deleted datetime<br><br>SELECT @ldt_patients_deleted = max(l.executed_date_time)<br>FROM c_Database_Script_Log l<br>&nbsp;&nbsp;&nbsp; INNER JOIN c_Database_Script s<br>&nbsp;&nbsp;&nbsp; ON l.script_id = s.script_id<br>WHERE s.script_type = 'Migration24'<br>AND s.script_name = '120 Patient Setup'<br><br>IF @ldt_patients_deleted IS NULL<br>&nbsp;&nbsp;&nbsp; RETURN<br><br>UPDATE p_Attachment<br>SET storage_flag = 'F'<br>WHERE storage_flag IS NULL<br>AND created &lt; @ldt_patients_deleted<br>GO<br><br><br>DECLARE @ll_default_attachment_location_id int<br><br>SELECT @ll_default_attachment_location_id = min(attachment_location_id)<br>FROM c_Attachment_Location<br>WHERE status = 'OK'<br><br>UPDATE p_Patient<br>SET attachment_location_id = @ll_default_attachment_location_id<br>WHERE attachment_location_id IS NULL<br>OR attachment_location_id NOT IN (<br>&nbsp;&nbsp;&nbsp; SELECT attachment_location_id<br>&nbsp;&nbsp;&nbsp; FROM c_Attachment_Location<br>&nbsp;&nbsp;&nbsp; WHERE status = 'OK')<br>GO<br><br></p><p>-------------------------------------------------------------<br><br></p><font size="2"></font></p><h3>Resolution</h3><p>This problem has been fixed in version 10 of the migration scripts.</p><h3>Notes</h3><p><br></p>